<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rock Paper Scissors DApp</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Rock Paper Scissors DApp</h1>
    <div id="connection-status">Not connected to MetaMask</div>
    <button id="connect-button">Connect to MetaMask</button>
    <div>
        <h2>Play Game</h2>
        <input type="number" id="bet-amount" placeholder="Bet amount in ETH" step="0.01" min="0" max="1">
        <button id="rock-button">Rock</button>
        <button id="paper-button">Paper</button>
        <button id="scissors-button">Scissors</button>
    </div>
    <div id="game-result"></div>

    <script type="module">
        const contractAddress = "0x2cee812ad2159Eb22D8403ccF494216BCC9cbDD4";
        const contractABI = [
            {"type":"constructor","inputs":[],"stateMutability":"payable"},
            {"type":"receive","stateMutability":"payable"},
            {"type":"function","name":"FEE_PERCENTAGE","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},
            {"type":"function","name":"MAX_BET","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},
            {"type":"function","name":"getAdminPoolBalance","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},
            {"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},
            {"type":"function","name":"playGame","inputs":[{"name":"_move","type":"uint8","internalType":"uint8"}],"outputs":[],"stateMutability":"payable"},
            {"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},
            {"type":"function","name":"testGenerateRandom","inputs":[],"outputs":[{"name":"randomBig","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},
            {"type":"function","name":"testRandomModulo","inputs":[],"outputs":[{"name":"randomMod","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},
            {"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},
            {"type":"function","name":"withdrawFunds","inputs":[{"name":"amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},
            {"type":"event","name":"BetPlaced","inputs":[{"name":"player","type":"address","indexed":false,"internalType":"address"},{"name":"bet","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},
            {"type":"event","name":"GamePlayed","inputs":[{"name":"player","type":"address","indexed":false,"internalType":"address"},{"name":"playerMove","type":"uint8","indexed":false,"internalType":"uint8"},{"name":"opponentMove","type":"uint8","indexed":false,"internalType":"uint8"},{"name":"outcome","type":"uint8","indexed":false,"internalType":"uint8"},{"name":"bet","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"winnings","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},
            {"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},
            {"type":"event","name":"Withdrawal","inputs":[{"name":"player","type":"address","indexed":false,"internalType":"address"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false}
        ];

        let signer, contract;

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    document.getElementById('connection-status').textContent = 'Connected to MetaMask';
                    document.getElementById('connect-button').style.display = 'none';
                } 
                catch (error) {
                    console.error("User denied account access", error);
                    alert("User denied account access");
                }
            } 
            else {
                console.log('Please install MetaMask!');
                alert('Please install MetaMask!');
            }
        }

        async function playGame(move) {
            if (!contract) {
                alert("Please connect to MetaMask first");
                return;
            }
            
            const betAmount = document.getElementById('bet-amount').value;
            if (!betAmount || isNaN(betAmount) || betAmount < 0 || betAmount > 1) {
                alert("Bet amount must be a number between 0 and 1 ETH");
                return;
            }

            try {
                const tx = await contract.playGame(move, {
                    value: ethers.utils.parseEther(betAmount),
                    gasLimit: 300000 // Optional: Set an appropriate gas limit
                });
                const receipt = await tx.wait();
                
                for (const event of receipt.events) {
                    if (event.event === 'GamePlayed') {
                        const [player, playerMove, opponentMove, outcome, bet, winnings] = event.args;
                        const moves = ['Rock', 'Paper', 'Scissors'];
                        const outcomes = ['Tie', 'Win', 'Lose'];
                        document.getElementById('game-result').innerHTML = `
                            Player Move: ${moves[playerMove]}<br>
                            Opponent Move: ${moves[opponentMove]}<br>
                            Outcome: ${outcomes[outcome]}<br>
                            Bet: ${ethers.utils.formatEther(bet)} ETH<br>
                            Winnings: ${ethers.utils.formatEther(winnings)} ETH
                        `;
                    }
                }
            } catch (error) {
                console.error("Error playing game:", error);
                alert("Error playing game. Check console for details.");
            }
        }

        document.getElementById('connect-button').addEventListener('click', connectWallet);
        document.getElementById('rock-button').addEventListener('click', () => playGame(0));
        document.getElementById('paper-button').addEventListener('click', () => playGame(1));
        document.getElementById('scissors-button').addEventListener('click', () => playGame(2));
    </script>
</body>
</html>
